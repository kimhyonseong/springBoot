<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <meta charset="UTF-8">
    <title>Cart</title>
</head>
<body>
<th:block layout:fragment="content">
    <div class="cart-box">
        <div class="cart-item-box"></div>
        <div class="show-more">더보기</div>
        <div class="delete-check">체크항목 삭제</div>
        <div class="order-check">체크항목 구매</div>
        <div class="order-all">전체 구매</div>
        <div class="delete-all">전체 삭제</div>
    </div>
    <script>
        let page = 0;
        let listFrom = `<div class="cart-item"><label>
                            <input type="checkbox" class="itemCheck" value="_CART_INDEX">
                        </label>
                        <div class="item-img">
                            <img src="_IMG" alt="_ITEM_NAME">
                        </div>
                        <div class="item-info">
                            <div>_ITEM_NAME</div>
                            <div>_ITEM_QUANTITY</div>
                            <div>_DETAIL</div>
                            <div class="delete-item" data-idx="_CART_INDEX">삭제</div>
                        </div></div>`;

        showCart();
        document.querySelector(".show-more").addEventListener("click",showCart);
        document.querySelector(".delete-all").addEventListener("click",deleteAll);
        document.querySelector(".delete-check").addEventListener("click",deleteChecked);
        document.querySelector(".cart-item-box")?.addEventListener("click",deleteCart);

        function showCart() {
            $.ajax({
                url : `/api/shopping/cart?page=${page}`,
                success:function (data) {
                    let html = "";

                    Array.from(data.cart).forEach((result) => {
                        let imgSrc = result.itemImg?.imgPath+result.itemImg?.fileName;
                        if (typeof imgSrc !== "string") imgSrc = "https://via.placeholder.com/150";

                        html += listFrom.replaceAll("_ITEM_NAME",result.cart.item.name)
                            .replaceAll("_CART_INDEX",result.cart.idx)
                            .replace("_ITEM_QUANTITY",result.cart.amount)
                            .replace("_DETAIL",result.cart.item.description)
                            .replace("_IMG",imgSrc)
                    })

                    if (data.totalPage <= data.currentPage) {
                        $(".show-more").remove();
                    }

                    $(".cart-item-box").append(html);
                    page++;
                }
            })
        }

        function deleteAll() {
            if (confirm("정말 아이템 전체를 삭제하시겠습니까?")) {
                $.ajax({
                    url: '/api/shopping/cart',
                    type: 'DELETE',
                    success: function (e) {
                        console.log(e);
                        alert(e.message);
                        location.reload();
                    }
                })
            }
        }

        function deleteChecked() {
            let arr = [];
            let itemIdxList = document.querySelectorAll(".itemCheck:checked");

            itemIdxList.forEach((ele) => {
                arr.push(ele.value);
            })

            if (confirm("선택된 아이템을 삭제하시겠습니까?")) {
                $.ajax({
                    url: '/api/shopping/cart/list',
                    type: 'DELETE',
                    contentType: 'application/json',
                    data:JSON.stringify(arr),
                    success: function (e) {
                        alert(e.message);
                        location.reload();
                    }
                })
            }
        }

        function deleteCart(e) {
            if (e.target.classList.contains("delete-item")) {
                console.log(e.target.dataset.idx);

                if (confirm("선택된 아이템을 삭제하시겠습니까?")) {
                    $.ajax({
                        url: `/api/shopping/cart/${e.target.dataset.idx}`,
                        type: 'DELETE',
                        contentType: 'application/json',
                        success: function (e) {
                            alert(e.message);
                            location.reload();
                        }
                    })
                }
            }
        }
    </script>
</th:block>
</body>
</html>